<Page xmlns="http://schemas.nativescript.org/tns.xsd"
      navigatingTo="onNavigatingTo"
      navigatingFrom="onNavigatingFrom">
  <ActionBar class="app-bar" flat="true">
    <ActionBar.titleView>
      <GridLayout columns="auto,*">
        <FlexboxLayout class="brand">
          <Image class="brand-icon" src="~/assets/logo.png" />
          <Label class="brand-title">
            <FormattedString>
              <Span text="Tic-Tac-Toe" />
              <Span text="Twist" class="twist" />
            </FormattedString>
          </Label>
        </FlexboxLayout>
      </GridLayout>
    </ActionBar.titleView>
    <NavigationButton text="Back" android.systemIcon="ic_menu_back" tap="onBack" />
  </ActionBar>
  <GridLayout rows="*" columns="*">
    <ScrollView row="0" col="0">
      <StackLayout class="screen" spacing="20">
        <StackLayout class="card game-info" padding="10" spacing="8" visibility="{{ resultVisible ? 'collapse' : 'visible' }}">
          <Label textWrap="true">
            <FormattedString>
              <Span text="Difficulty: " fontWeight="bold" />
              <Span text="{{ difficultyLabel }}" />
            </FormattedString>
          </Label>
          <Label textWrap="true">
            <FormattedString>
              <Span text="Win condition: " fontWeight="bold" />
              <Span text="{{ winLengthLabel }}" />
            </FormattedString>
          </Label>
          <Label textWrap="true">
            <FormattedString>
              <Span text="Rules: " fontWeight="bold" />
              <Span text="{{ variantSummary.length > 0 ? 'Variants' : 'Classic' }}" />
            </FormattedString>
          </Label>
          <Repeater items="{{ variantSummary }}" visibility="{{ variantSummary.length > 0 ? 'visible' : 'collapse' }}">
            <Repeater.itemsLayout>
                <StackLayout />
            </Repeater.itemsLayout>
            <Repeater.itemTemplate>
                <Label text="{{ $value }}" />
            </Repeater.itemTemplate>
          </Repeater>
          <Label textWrap="true">
            <FormattedString>
              <Span text="One-Time-Powers: " fontWeight="bold" />
              <Span text="{{ otpSummary.length < 1 ? 'Vanilla' : '' }}" />
            </FormattedString>
          </Label>
          <Repeater items="{{ otpSummary }}" visibility="{{ otpSummary.length > 0 ? 'visible' : 'collapse' }}">
            <Repeater.itemsLayout>
                <StackLayout />
            </Repeater.itemsLayout>
            <Repeater.itemTemplate>
                <Label text="{{ $value }}" />
            </Repeater.itemTemplate>
          </Repeater>
          <Repeater items="{{ otpPowerItems }}" visibility="{{ otpPowerItems.length > 0 ? 'visible' : 'collapse' }}">
            <Repeater.itemsLayout>
                <FlexboxLayout class="otp-wrapper" flexDirection="row" alignItems="center" justifyContent="center"></FlexboxLayout>
            </Repeater.itemsLayout>
            <Repeater.itemTemplate>
              <StackLayout class="{{`otp-section ${id}`}}">
                <Label class="otp-title" text="{{ title }}" />
                <Label class="otp-description" text="{{ description }}" textWrap="true" />
                <Button class="{{ armed ? 'otp-button armed' : 'otp-button' }}"
                        text="{{ buttonText }}"
                        tap="onOtpPowerAction"
                        isEnabled="{{ buttonEnabled }}" />
              </StackLayout>
            </Repeater.itemTemplate>
          </Repeater>
          <FlexboxLayout class="turn-banner" flexDirection="row" alignItems="center" justifyContent="center">
            <ActivityIndicator class="thinking-spinner" busy="{{ aiThinkingVisible }}" visibility="{{ aiThinkingVisible ? 'visible' : 'collapse' }}" />
            <Label class="status" text="{{ aiThinkingMessage }}" visibility="{{ aiThinkingVisible ? 'visible' : 'collapse' }}" />
            <Label text="{{ statusText }}" class="status" textWrap="true" visibility="{{ aiThinkingVisible ? 'collapse' : 'visible' }}" />
          </FlexboxLayout>
        </StackLayout>

        <StackLayout class="card result-card" padding="10" spacing="12" visibility="{{ resultVisible ? 'visible' : 'collapse' }}">
          <Label textWrap="true">
            <FormattedString>
              <Span text="Difficulty: " fontWeight="bold" />
              <Span text="{{ resultDifficultyLabel }}" />
            </FormattedString>
          </Label>
          <Label textWrap="true">
            <FormattedString>
              <Span text="Win condition: " fontWeight="bold" />
              <Span text="{{ resultWinLengthLabel }}" />
            </FormattedString>
          </Label>
          <Label textWrap="true">
            <FormattedString>
              <Span text="Rules: " fontWeight="bold" />
              <Span text="{{ resultVariantSummary.length > 0 ? 'Variants' : 'Classic' }}" />
            </FormattedString>
          </Label>
          <Repeater items="{{ resultVariantSummary }}" visibility="{{ resultVariantSummary.length > 0 ? 'visible' : 'collapse' }}">
            <Repeater.itemsLayout>
                <StackLayout />
            </Repeater.itemsLayout>
            <Repeater.itemTemplate>
                <Label text="{{ $value }}" />
            </Repeater.itemTemplate>
          </Repeater>
          <Label textWrap="true">
            <FormattedString>
              <Span text="One-Time-Powers: " fontWeight="bold" />
              <Span text="{{ resultOtpSummary.length < 1 ? 'Vanilla' : '' }}" />
            </FormattedString>
          </Label>
          <Repeater items="{{ resultOtpSummary }}" visibility="{{ resultOtpSummary.length > 0 ? 'visible' : 'collapse' }}">
            <Repeater.itemsLayout>
                <StackLayout />
            </Repeater.itemsLayout>
            <Repeater.itemTemplate>
                <Label text="{{ $value }}" />
            </Repeater.itemTemplate>
          </Repeater>
          <StackLayout class="result-banner">
            <Label text="{{ resultTitle }}" class="result-title" textWrap="true" />
            <Label text="{{ resultSummary }}" class="result-summary" textWrap="true" />
          </StackLayout>
        </StackLayout>

        <FlexboxLayout class="board-shell" justifyContent="center">
          <StackLayout class="{{ boardClass }}" orientation="vertical">
            <Repeater items="{{ boardRows }}">
              <Repeater.itemTemplate>
                <FlexboxLayout class="board-row" flexDirection="row" justifyContent="center">
                  <Repeater items="{{ cells }}">
                    <Repeater.itemsLayout>
                      <FlexboxLayout flexDirection="row" />
                    </Repeater.itemsLayout>
                    <Repeater.itemTemplate>
                      <Label text="{{ text }}"
                             class="{{ cssClass }}"
                             tap="onCellTap" />
                    </Repeater.itemTemplate>
                  </Repeater>
                </FlexboxLayout>
              </Repeater.itemTemplate>
            </Repeater>
          </StackLayout>
        </FlexboxLayout>

        <FlexboxLayout class="result-actions" flexDirection="row" justifyContent="center" alignItems="center" visibility="{{ resultVisible ? 'visible' : 'collapse' }}">
          <Button text="âª Replay" tap="onReplay" isEnabled="{{ !replayActive }}" />
          <Button text="ðŸ” Rematch" tap="onRematch" />
          <Button text="âï¸ Game Setup" tap="onChangeGameSetup" />
        </FlexboxLayout>
        <ScrollView class="replay-log" isScrollEnabled="true" height="150" visibility="{{ replayLogsVisible ? 'visible' : 'collapse' }}">
          <StackLayout padding="10" spacing="8">
            <Label text="Replay log" class="replay-log-title" />
            <Repeater items="{{ replayLogs }}">
              <Repeater.itemTemplate>
                <Label text="{{ text }}" class="replay-log-entry" textWrap="true" />
              </Repeater.itemTemplate>
            </Repeater>
          </StackLayout>
        </ScrollView>

        <StackLayout class="game-actions" padding="10" spacing="12" visibility="{{ resultVisible ? 'collapse' : 'visible' }}">
          <Button text="ðŸ” Rematch" tap="onRematch" />
          <Button text="âï¸ Game Setup" tap="onBack" />
        </StackLayout>
      </StackLayout>
    </ScrollView>
    <AbsoluteLayout id="confettiLayer" row="0" col="0" class="confetti-layer" isHitTestVisible="false" visibility="{{ confettiVisible ? 'visible' : 'collapse' }}" horizontalAlignment="stretch" verticalAlignment="stretch" />
  </GridLayout>
</Page>
